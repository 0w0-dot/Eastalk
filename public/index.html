<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Eastalk (Web)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== Design Tokens ===== */
    :root{
      --bg:#ffffff; --panel:#ffffff; --line:#e5e7eb;
      --text:#111827; --muted:#6b7280;
      --accent:#ffd400; --accent-ink:#111;
      --bubble-me:#fff7cc; --bubble-other:#f3f4f6;

      --radius-sm:10px; --radius-md:12px; --radius-lg:16px;
      --shadow-1:0 1px 2px rgba(0,0,0,.06);
      --shadow-2:0 6px 24px rgba(0,0,0,.08);
      --focus: 0 0 0 3px rgba(0,0,0,.08), 0 0 0 6px rgba(255,212,0,.45);
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif;
      background:var(--bg); color:var(--text);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* ===== App Shell ===== */
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 16px; border-bottom:1px solid var(--line);
      background:#fafafa; position:sticky; top:0; z-index:5;
    }
    header .brand{ font-weight:700; letter-spacing:.2px; }
    header .brand span{ color:var(--accent); }
    #topStatus{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:40vw; }

    .wrap{
      display:flex; gap:12px; padding:12px; max-width:1024px; margin:0 auto;
      height:calc(100vh - 56px); overflow:hidden; min-height:0;
    }
    @supports (height: 100dvh){
      .wrap{ height:calc(100dvh - 56px); }
    }
    @supports not (height: 100dvh){
      .wrap{ height:calc(var(--vh, 1vh) * 100 - 56px); }
    }

    .left,.right{ background:var(--panel); border:1px solid var(--line); border-radius:var(--radius-lg); }
    .left{ width:320px; padding:12px; overflow:auto; -webkit-overflow-scrolling:touch; touch-action:pan-y; }
    .right{ flex:1; display:flex; flex-direction:column; min-height:0; }

    /* ===== Profile ===== */
    .profile{ display:flex; align-items:center; gap:12px; }
    .avatar{ width:48px; height:48px; border-radius:50%; background:#e5e7eb; overflow:hidden; }
    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; }
    .fields{ margin-top:12px; display:grid; gap:8px; }
    .status{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--muted); font-size:12px; }

    /* Inputs & Buttons */
    .input{
      width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:var(--radius-sm);
      font-size:14px; background:#fff; color:var(--text); transition:border-color .15s, box-shadow .15s;
    }
    .input::placeholder{ color:var(--muted); }
    .input:focus{ outline:none; border-color:#d1d5db; box-shadow:var(--focus); }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      height:44px; padding:0 16px; border-radius:999px; border:1px solid transparent;
      font-weight:700; cursor:pointer; user-select:none; transition:transform .02s, box-shadow .15s;
    }
    .btn:active{ transform:translateY(1px); }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .btn-primary{ background:var(--accent); color:var(--accent-ink); box-shadow:var(--shadow-1); }
    .btn-ghost{ background:#fff; color:var(--text); border:1px solid var(--line); }
    .btn-icon{ width:44px; padding:0; }

    .spinner{ width:16px; height:16px; border-radius:50%; border:2px solid currentColor; border-top-color:transparent; animation:spin .8s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* Tabs (Î™®Î∞îÏùº: Í∞ÄÎ°ú Ïä§ÌÅ¨Î°§) */
    .tabs{
      display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--line); background:#fafafa;
      overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:thin;
      white-space:nowrap; touch-action:pan-y;
    }
    .tab{
      display:inline-flex; align-items:center; justify-content:center;
      padding:8px 12px; border:1px solid var(--line); border-radius:999px; background:#fff; cursor:pointer;
      max-width:50vw; text-overflow:ellipsis; overflow:hidden; white-space:nowrap;
    }
    .tab.active{ background:var(--accent); color:var(--accent-ink); border-color:transparent; }

    /* Messages */
    .messages{
      flex:1; overflow-y:auto; padding:12px; padding-bottom:96px;
      display:flex; flex-direction:column; gap:8px; background:#fff;
      -webkit-overflow-scrolling:touch; touch-action:pan-y; min-height:0;
    }
    .msg-row{ display:flex; align-items:flex-end; gap:8px; }
    .msg-row.me{ justify-content:flex-end; }
    /* avatar button (clickable) */
    .avatar-sm{
      width:28px; height:28px; border-radius:50%; background:#e5e7eb; overflow:hidden;
      flex:0 0 28px; display:flex; align-items:center; justify-content:center; font-size:12px; color:#6b7280;
      border:0; padding:0; cursor:pointer;
    }
    .avatar-sm img{ width:100%; height:100%; object-fit:cover; display:block; }
    .bubble{ max-width:86%; padding:12px 14px; border:1px solid var(--line); border-radius:16px; line-height:1.42; background:var(--bubble-other); box-shadow:var(--shadow-1); }
    .msg-row.me .bubble{ background:var(--bubble-me); }
    .meta{ font-size:11px; color:var(--muted); margin-top:6px; }

    /* Reactions */
    .reacts{ margin-top:8px; display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
    .chip{ display:inline-flex; align-items:center; gap:4px; padding:2px 8px; border:1px solid var(--line); border-radius:999px; font-size:12px; background:#fff; cursor:pointer; user-select:none; }
    .chip.mine{ border-color:#f59e0b; background:#fff7e6; }
    .add-react{ border:1px dashed var(--line); background:#fff; border-radius:999px; padding:2px 10px; font-size:12px; cursor:pointer; }
    .picker{ display:flex; gap:6px; margin-left:2px; }
    .picker.hidden{ display:none; }
    .pick{ background:#fff; border:1px solid var(--line); border-radius:8px; padding:4px 6px; cursor:pointer; }

    /* Composer (safe-area Í≥†Î†§) */
    .composer{
      display:flex; gap:8px; padding:10px; padding-bottom:calc(10px + env(safe-area-inset-bottom));
      border-top:1px solid var(--line);
      background:#fff; position:sticky; bottom:0; z-index:3; box-shadow:0 -6px 18px rgba(0,0,0,.04);
    }
    .composer .input{ height:48px; }

    /* Login Overlay */
    .auth{ position:fixed; inset:0; display:grid; place-items:center; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); z-index:9999; }
    .auth.hidden{ display:none; }
    .dialog{ width:min(460px, calc(100vw - 32px)); border-radius:20px; background:#fff; border:1px solid var(--line); box-shadow:var(--shadow-2); }
    .dialog header{ position:relative; border-bottom:1px solid var(--line); background:#fff; border-radius:20px 20px 0 0; cursor:grab; }
    .dialog main{ padding:16px; display:grid; gap:12px; }
    .field{ display:grid; gap:6px; }
    .label{ font-size:12px; color:var(--muted); }
    .helper{ font-size:12px; color:var(--muted); }
    .row-actions{ padding:12px 16px 16px; display:flex; gap:8px; }
    .dialog .btn-primary{ width:100%; height:48px; }
    body.auth-open{ overflow:hidden; }
    .shake{ animation:shake .28s ease-in-out; }
    @keyframes shake{ 0%,100%{ transform:translateX(0);} 25%{ transform:translateX(-6px);} 75%{ transform:translateX(6px);} }

    /* ===== Mobile layout tweaks ===== */
    #profileBtn{ display:none; }
    #scrim{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:15; }
    @media (max-width: 880px){
      .wrap{ flex-direction:column; gap:8px; }
      .right{ order:2; }
      .left{ display:none; }
      #profileBtn{ display:inline-flex; height:32px; }
      #topStatus{ display:none; }
      body.profile-open #scrim{ display:block; }
      body.profile-open .left{
        display:block; position:fixed; z-index:20;
        top:56px; bottom:calc(84px + env(safe-area-inset-bottom)); left:8px; right:8px;
        border-radius:16px; overflow:auto; -webkit-overflow-scrolling:touch; touch-action:pan-y;
      }
      /* Î™®Î∞îÏùº Ï†ëÏÜçÏûê Î™©Î°ù */
      .connected-users .user-avatar{ width:28px; height:28px; font-size:11px; }
      .btn{ height:40px; }
      .btn-icon{ width:40px; }
      .bubble{ max-width:92%; }
      .messages{ padding-bottom:120px; }
      .tabs .tab{ max-width:60vw; }
    }
    @media (max-width: 480px){
      .composer .input{ height:44px; }
      .tabs .tab{ max-width:70vw; }
      /* Îçî ÏûëÏùÄ ÌôîÎ©¥ÏóêÏÑú Ï†ëÏÜçÏûê ÏïÑÎ∞îÌÉÄ ÌÅ¨Í∏∞ Ï°∞Ï†ï */
      .connected-users .user-avatar{ width:26px; height:26px; font-size:10px; }
      .connected-users .users-grid{ gap:3px; }
    }

    /* ===== Day separator (Ïπ¥ÌÜ° Ïä§ÌÉÄÏùº) ===== */
    .day-sep{ display:flex; align-items:center; gap:12px; margin:12px 0; color:var(--muted); font-size:12px; }
    .day-sep::before,.day-sep::after{ content:""; flex:1; height:1px; background:var(--line); }
    .day-chip{ background:#fff; border:1px solid var(--line); border-radius:999px; padding:4px 10px; }
    body.win98 .day-sep::before, body.win98 .day-sep::after{ background:#808080; }
    body.win98 .day-chip{
      background:#c0c0c0;
      border:2px solid #c0c0c0; border-top-color:#fff; border-left-color:#fff;
      border-right-color:#404040; border-bottom-color:#404040;
    }

    /* ===== Connected Users ===== */
    .connected-users{ margin-top:16px; }
    .connected-header{ font-size:12px; color:var(--muted); margin-bottom:8px; font-weight:500; }
    .users-grid{ display:flex; flex-wrap:wrap; gap:4px; }
    .user-avatar{ 
      width:32px; height:32px; border-radius:50%; background:#e5e7eb; 
      overflow:hidden; cursor:pointer; border:2px solid transparent;
      transition:border-color .15s, transform .02s;
      display:flex; align-items:center; justify-content:center;
      font-size:12px; color:#6b7280; font-weight:500;
    }
    .user-avatar:hover{ border-color:var(--accent); transform:scale(1.05); }
    .user-avatar img{ width:100%; height:100%; object-fit:cover; display:block; }

    /* Win98 Ïä§ÌÉÄÏùº */
    body.win98 .connected-users{ border-top:1px solid #808080; padding-top:8px; }
    body.win98 .connected-header{ color:#404040; }
    body.win98 .user-avatar{ 
      background:#c0c0c0; color:#000;
      border:2px solid #c0c0c0; border-top-color:#fff; border-left-color:#fff;
      border-right-color:#404040; border-bottom-color:#404040;
    }
    body.win98 .user-avatar:hover{ 
      border-top-color:#404040; border-left-color:#404040;
      border-right-color:#fff; border-bottom-color:#fff;
      transform:none;
    }

    /* ===== Profile Modal ===== */
    .pmodal{ position:fixed; inset:0; display:none; place-items:center; z-index:60; }
    .pmodal.show{ display:grid; }
    .pback{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
    .pcard{
      position:relative; width:min(420px, calc(100vw - 32px));
      background:#fff; border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow-2);
      padding:16px; display:grid; gap:12px; z-index:1;
    }
    .pclose{ position:absolute; top:8px; right:8px; border:0; background:#fff; border:1px solid var(--line); border-radius:8px; padding:6px 8px; cursor:pointer; }
    .pavatar{ width:100%; display:grid; place-items:center; }
    .pavatar img{ width:180px; height:180px; border-radius:50%; object-fit:cover; background:#e5e7eb; }
    .pname{ font-weight:700; font-size:16px; text-align:center; }
    .pstatus{ font-size:14px; color:var(--muted); text-align:center; word-break:break-word; }
    @media (max-width:480px){ .pavatar img{ width:140px; height:140px; } }

    /* Retro98 Î≥ÄÌòï */
    body.win98 .pcard{ background:#c0c0c0; border:2px solid #808080; }
    body.win98 .pclose{
      background:#c0c0c0; border:2px solid #c0c0c0; border-top-color:#fff; border-left-color:#fff; border-right-color:#404040; border-bottom-color:#404040;
    }

    /* ===== Retro 98 Theme ===== */
    body.win98{
      --panel:#c0c0c0; --line:#808080; --text:#000; --muted:#404040; --accent:#c0c0c0; --accent-ink:#000;
    }
    body.win98, body.win98 *{
      border-radius:0 !important; box-shadow:none !important;
      font-family: Tahoma, Verdana, "MS Sans Serif", Arial, sans-serif !important; font-size:12px;
    }
    .w98-out{ border:2px solid #c0c0c0; border-top-color:#fff; border-left-color:#fff; border-right-color:#404040; border-bottom-color:#404040; background:#c0c0c0; }
    .w98-in{ border:2px solid #808080; border-top-color:#404040; border-left-color:#404040; border-right-color:#fff; border-bottom-color:#fff; background:#fff; }

    body.win98 header{ background:linear-gradient(#000080,#1084d0); color:#fff; border-bottom:2px solid #000; }
    body.win98 header .brand span{ color:#fff; }
    body.win98 .left, body.win98 .right, body.win98 .tabs, body.win98 .composer, body.win98 .dialog{ background:#c0c0c0; }
    body.win98 .messages{ background:#fff; border:2px solid #808080; border-top-color:#404040; border-left-color:#404040; border-right-color:#fff; border-bottom-color:#fff; }

    body.win98 .input{ height:24px; padding:4px 6px; border:2px solid #808080; border-top-color:#404040; border-left-color:#404040; border-right-color:#fff; border-bottom-color:#fff; }
    body.win98 .input:focus{ outline:1px dotted #000; box-shadow:none; }

    body.win98 .btn{ height:26px; padding:0 10px; border:2px solid #c0c0c0; border-top-color:#fff; border-left-color:#fff; border-right-color:#404040; border-bottom-color:#404040; background:#c0c0c0; color:#000; font-weight:400; }
    body.win98 .btn:active{ border-top-color:#404040; border-left-color:#404040; border-right-color:#fff; border-bottom-color:#fff; }
    body.win98 .btn-primary{ background:#c0c0c0; }
    body.win98 .btn-icon{ width:26px; }

    body.win98 .tab{ border:2px solid #c0c0c0; border-top-color:#fff; border-left-color:#fff; border-right-color:#404040; border-bottom-color:#404040; background:#c0c0c0; }
    body.win98 .tab.active{ border-top-color:#404040; border-left-color:#404040; border-right-color:#fff; border-bottom-color:#fff; color:#000; }

    body.win98 .bubble{ background:#fff !important; color:#000; border:1px solid #000; padding:8px 10px; }
    body.win98 .meta{ color:#404040; }

    body.win98 .chip, body.win98 .add-react, body.win98 .pick{
      background:#c0c0c0; color:#000;
      border:2px solid #c0c0c0; border-top-color:#fff; border-left-color:#fff; border-right-color:#404040; border-bottom-color:#404040;
    }
    body.win98 .chip.mine{ background:#ffffe1; }

    body.win98 .composer{ background:#c0c0c0; }
    body.win98 .composer .input{ height:24px; }

    body.win98 .dialog{ background:#c0c0c0; }
    body.win98 .dialog header{ background:linear-gradient(#000080,#1084d0)!important; color:#fff!important; border-bottom:2px solid #000; }
    body.win98 .dialog header::after{ content:" _  ‚ñ°  X "; position:absolute; right:10px; top:8px; color:#fff; font-family:"Courier New",monospace; font-weight:700; }

    @media (max-width:880px){
      body.win98{ font-size:11px; }
      body.win98 .btn{ height:24px; }
      body.win98 .btn-icon{ width:24px; }
      body.win98 .input{ height:22px; }
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="auth-open">
  <header>
    <div class="brand">Eastalk <span>‚Ä¢ Web</span></div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button id="profileBtn" class="btn btn-ghost">üë§ ÌîÑÎ°úÌïÑ</button>
      <button id="toggle98" class="btn btn-ghost">üñ•Ô∏è Retro 98</button>
      <button id="logoutBtn" class="btn btn-ghost" style="display:none">Î°úÍ∑∏ÏïÑÏõÉ</button>
      <div class="status" id="topStatus">‚Äî</div>
    </div>
  </header>

  <div id="scrim"></div>

  <div class="wrap" aria-disabled="true">
    <!-- LEFT (Profile Drawer on mobile) -->
    <aside class="left">
      <div class="profile">
        <div class="avatar"><img id="avatarImg" alt="" /></div>
        <div>
          <div id="nicknameView" style="font-weight:700;">User</div>
          <div id="statusView" class="status">ÏÉÅÌÉúÎ©îÏãúÏßÄ‚Ä¶</div>
        </div>
      </div>
      <div class="fields">
        <input id="nickname" class="input" placeholder="ÎãâÎÑ§ÏûÑ" disabled />
        <input id="status" class="input" placeholder="ÏÉÅÌÉúÎ©îÏãúÏßÄ (Ïòà: ÏùºÌïòÎäî Ï§ë‚Ä¶)" disabled />
        <input id="avatar" class="input" placeholder="ÏïÑÎ∞îÌÉÄ Ïù¥ÎØ∏ÏßÄ URL (ÏÑ†ÌÉù)" disabled />
        <!-- Ï∂îÍ∞Ä: ÏïÑÎ∞îÌÉÄ ÏßÄÏö∞Í∏∞ -->
        <label class="status" style="display:flex;align-items:center;gap:6px;">
          <input type="checkbox" id="clearAvatar" disabled />
          ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏßÄÏö∞Í∏∞
        </label>
        <button id="saveBtn" class="btn btn-primary" disabled>ÌîÑÎ°úÌïÑ Ï†ÄÏû•</button>
        <div class="status" id="loginNotice">* Î°úÍ∑∏Ïù∏ ÏôÑÎ£å ÌõÑ ÏÇ¨Ïö© Í∞ÄÎä•Ìï©ÎãàÎã§.</div>
      </div>

      <!-- ÌòÑÏû¨ Ï†ëÏÜçÏûê -->
      <div class="connected-users" id="connectedUsers" style="display:none">
        <div class="connected-header" id="connectedHeader">ÌòÑÏû¨ Ï†ëÏÜçÏûê (0)</div>
        <div class="users-grid" id="usersGrid"></div>
      </div>
    </aside>

    <!-- RIGHT -->
    <section class="right">
      <div class="tabs" id="tabs"></div>
      <div class="messages" id="messages"></div>

      <div class="composer">
        <input id="text" class="input" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†• (Enter Ï†ÑÏÜ°, Shift+Enter Ï§ÑÎ∞îÍøà)" disabled />
        <button id="photoBtn" class="btn btn-ghost btn-icon" title="ÏÇ¨ÏßÑ">üì∑</button>
        <button id="sendBtn" class="btn btn-primary">
          <span class="label-txt">Î≥¥ÎÇ¥Í∏∞</span>
          <span class="spinner" style="display:none"></span>
        </button>
      </div>

      <form id="uploadForm" style="display:none">
        <input type="file" id="image" name="image" accept="image/*" />
      </form>
    </section>
  </div>

  <!-- LOGIN -->
  <div class="auth" id="auth" role="dialog" aria-modal="true" aria-labelledby="dlg-title">
    <div class="dialog" id="dialogCard">
      <header id="dlgDragHandle">
        <div style="padding:12px 16px; font-weight:700;" id="dlg-title">Eastalk Î°úÍ∑∏Ïù∏</div>
      </header>
      <main>
        <div class="helper">Ïù¥Î¶ÑÍ≥º ÏÉùÏùº 4ÏûêÎ¶¨(MMDD)Î•º ÏûÖÎ†•ÌïòÎ©¥ Í∏∞Ï°¥ Ï†ïÎ≥¥Î•º Î∂àÎü¨ÏòµÎãàÎã§. ÏóÜÏúºÎ©¥ ÏÉà Í≥ÑÏ†ïÏùÑ ÎßåÎì§Ïñ¥Ïöî.</div>
        <div class="field">
          <label class="label" for="loginName">Ïù¥Î¶Ñ</label>
          <input id="loginName" class="input" placeholder="Ïòà: ÌôçÍ∏∏Îèô" autocomplete="off" autocapitalize="off" spellcheck="false" />
        </div>
        <div class="field">
          <label class="label" for="loginBirth">ÏÉùÏùº 4ÏûêÎ¶¨</label>
          <input id="loginBirth" class="input" placeholder="MMDD" maxlength="4" inputmode="numeric" autocomplete="off" />
        </div>
      </main>
      <div class="row-actions">
        <button id="startBtn" class="btn btn-primary">ÏãúÏûëÌïòÍ∏∞</button>
      </div>
    </div>
  </div>

  <!-- PROFILE MODAL -->
  <div class="pmodal" id="pmodal" aria-hidden="true">
    <div class="pback" id="pback"></div>
    <div class="pcard" role="dialog" aria-modal="true" aria-labelledby="pname">
      <button class="pclose" id="pclose" aria-label="Îã´Í∏∞">‚úï</button>
      <div class="pavatar"><img id="pimg" alt="ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ" /></div>
      <div class="pname" id="pname">User</div>
      <div class="pstatus" id="pstatus">ÏÉÅÌÉúÎ©îÏãúÏßÄ‚Ä¶</div>
    </div>
  </div>

  <script>
    /* ===== ÏÉÅÌÉú Í¥ÄÎ¶¨ =====*/
    // ÏÉÅÏàò Ï†ïÏùò
    const CONFIG = {
      ROOMS: ['Ï£ºÏ§ë', 'Ï£ºÎßê', 'Ï†ÑÏ≤¥', 'Î∞©Î¨∏ÏòàÏ†ï'],
      EMOJIS: ['üëç', 'üòÇ', 'üòÆ', 'üò¢', 'üò°', '‚ù§Ô∏è'],
      MAX_MESSAGE_LENGTH: 2000,
      MAX_FILE_SIZE: 10 * 1024 * 1024, // 10MB
      SCROLL_THRESHOLD: 80
    };
    
    // Ï†ÑÏó≠ ÏÉÅÌÉú
    const AppState = {
      currentRoom: 'Ï£ºÏ§ë',
      userId: null,
      me: null,
      flags: {
        sending: false,
        uploading: false
      },
      cache: {
        renderedMids: { 
          'Ï£ºÏ§ë': new Set(), 
          'Ï£ºÎßê': new Set(), 
          'Ï†ÑÏ≤¥': new Set(), 
          'Î∞©Î¨∏ÏòàÏ†ï': new Set() 
        },
        lastTs: { 'Ï£ºÏ§ë': 0, 'Ï£ºÎßê': 0, 'Ï†ÑÏ≤¥': 0, 'Î∞©Î¨∏ÏòàÏ†ï': 0 },
        lastDayRendered: { 'Ï£ºÏ§ë': '', 'Ï£ºÎßê': '', 'Ï†ÑÏ≤¥': '', 'Î∞©Î¨∏ÏòàÏ†ï': '' }
      },
      connectedUsers: [] // ÌòÑÏû¨ Ï†ëÏÜçÏûê Î™©Î°ù
    };

    // Socket.io Ïó∞Í≤∞
    const socket = io();

    /* ===== ÎèÑÏö∞ÎØ∏ Ìï®ÏàòÎì§ ===== */
    // DOM Ïú†Ìã∏Î¶¨Ìã∞
    const DOM = {
      el: (selector) => document.querySelector(selector),
      elAll: (selector) => document.querySelectorAll(selector),
      create: (tag, className) => {
        const el = document.createElement(tag);
        if (className) el.className = className;
        return el;
      }
    };
    
    // Î†àÍ±∞Ïãú ÏßÄÏõêÏùÑ ÏúÑÌïú el Ìï®Ïàò Î≥µÏõê
    const el = (selector) => document.querySelector(selector);
    
    // Ï∫êÏãú ÎèÑÏö∞ÎØ∏
    const messagesEl = DOM.el('#messages');
    
    // ID Î∞è ÏãúÍ∑∏ÎãàÏ≤ò ÏÉùÏÑ±
    const Utils = {
      generateMessageId: () => `mid-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
      
      createReactionSignature: (reactions) => {
        if (!reactions || typeof reactions !== 'object') return '{}';
        
        const normalized = {};
        Object.keys(reactions)
          .sort((a, b) => a.localeCompare(b))
          .forEach(key => {
            normalized[key] = [...(reactions[key] || [])].sort();
          });
        return JSON.stringify(normalized);
      },
      
      setButtonLoading: (button, loading) => {
        if (!button) return;
        
        const spinner = button.querySelector('.spinner');
        const label = button.querySelector('.label-txt');
        
        if (loading) {
          if (spinner) spinner.style.display = 'inline-block';
          if (label) label.style.display = 'none';
          button.disabled = true;
        } else {
          if (spinner) spinner.style.display = 'none';
          if (label) label.style.display = '';
          button.disabled = false;
        }
      },
      
      sanitizeInput: (input, maxLength = CONFIG.MAX_MESSAGE_LENGTH) => {
        if (typeof input !== 'string') return '';
        return input.trim().slice(0, maxLength);
      }
    };

    /* ===== ÎÇ†Ïßú/ÏãúÍ∞Ñ Ìè¨Îß§ÌÑ∞ ===== */
    const DateUtils = {
      // ÎÇ†Ïßú ÌÇ§ ÏÉùÏÑ± (YYYY-M-D)
      getDateKey: (timestamp) => {
        const date = new Date(timestamp);
        return [date.getFullYear(), date.getMonth() + 1, date.getDate()].join('-');
      },
      
      // ÎÇ†Ïßú ÎùºÎ≤® Ìè¨Îß§ÌåÖ (2024.01.01 (Ïõî))
      formatDateLabel: (timestamp) => {
        const date = new Date(timestamp);
        const weekdays = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
        const weekday = weekdays[date.getDay()];
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        
        return `${year}.${month}.${day} (${weekday})`;
      },
      
      // ÏãúÍ∞Ñ ÎùºÎ≤® Ìè¨Îß§ÌåÖ (Ïò§Ï†Ñ 10:30)
      formatTimeLabel: (timestamp) => {
        return new Intl.DateTimeFormat('ko-KR', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        }).format(new Date(timestamp));
      }
    };

    /* ===== Win98 Toggle + Click Sound ===== */
    const applyTheme98 = (on)=>{
      document.body.classList.toggle('win98', !!on);
      localStorage.setItem('theme98',''+(on?1:0));
    };
    const restoreTheme98 = ()=> applyTheme98(localStorage.getItem('theme98')==='1');
    let audioCtx=null;
    function beep(){
      if (!document.body.classList.contains('win98')) return;
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
        o.type='square'; o.frequency.value=800;
        g.gain.setValueAtTime(0.06, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+0.08);
        o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.09);
      }catch(e){}
    }
    function attachBeepTo(selector){
      document.addEventListener('click', (e)=>{
        if (e.target.closest(selector)) beep();
      });
    }

    /* ===== Responsive helpers ===== */
    const isCompact = () => window.innerWidth <= 480;

    /* ===== UI Base ===== */
    function enableUI(enable){
      ['nickname','status','avatar','clearAvatar','saveBtn','text','sendBtn','photoBtn'].forEach(id=>{
        const n = DOM.el('#'+id); if (n) n.disabled = !enable;
      });
      DOM.el('.wrap').setAttribute('aria-disabled', enable ? 'false' : 'true');
      // Ìó§Îçî Î°úÍ∑∏ÏïÑÏõÉ Î≤ÑÌäº ÌÜ†Í∏Ä
      DOM.el('#logoutBtn').style.display = enable ? 'inline-flex' : 'none';
      // Î°úÍ∑∏Ïù∏ ÏïàÎÇ¥ Î¨∏Íµ¨ ÌÜ†Í∏Ä
      DOM.el('#loginNotice').style.display = enable ? 'none' : 'block';
    }
    function setAvatar(url){ const img=DOM.el('#avatarImg'); if(url&&url.trim()){ img.src=url; img.style.visibility='visible'; } else { img.removeAttribute('src'); img.style.visibility='hidden'; } }

    function labelFor(roomName){
      if (isCompact() && roomName.indexOf('Î∞©Î¨∏ÏòàÏ†ï')===0) return 'Î∞©Î¨∏ÏòàÏ†ï';
      return roomName;
    }
    function setActiveTabUI() {
      document.querySelectorAll('.tab').forEach(t=>{
        t.classList.toggle('active', t.textContent.replace(/\s/g,'') === UI.labelFor(AppState.currentRoom).replace(/\s/g,''));
      });
    }
    // ===== Î∞© Ï†ÑÌôò Í¥ÄÎ¶¨ =====
    const RoomManager = {
      switchRoom: (nextRoom) => {
        if (nextRoom === AppState.currentRoom) return;
        
        // ÏûÖÎ†• Í≤ÄÏ¶ù
        if (!CONFIG.ROOMS.includes(nextRoom)) {
          console.warn('ÏûòÎ™ªÎêú Î∞© Ïù¥Î¶Ñ:', nextRoom);
          return;
        }
        
        try {
          // Ïù¥Ï†Ñ Î∞©ÏóêÏÑú ÎÇòÍ∞ÄÍ∏∞
          socket.emit('leaveRoom', AppState.currentRoom);
          
          // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
          AppState.currentRoom = nextRoom;
          
          // UI Ï¥àÍ∏∞Ìôî
          messagesEl.innerHTML = '';
          // Î∞© Ï†ÑÌôò Ïãú Ìï¥Îãπ Î∞©Ïùò Î†åÎçîÎßÅÎêú Î©îÏãúÏßÄ ID Ï¥àÍ∏∞Ìôî (Ï†ÑÏ≤¥ Î©îÏãúÏßÄ Îã§Ïãú Î°úÎìúÎ•º ÏúÑÌï¥)
          AppState.cache.renderedMids[AppState.currentRoom].clear();
          AppState.cache.lastTs[AppState.currentRoom] = AppState.cache.lastTs[AppState.currentRoom] || 0;
          AppState.cache.lastDayRendered[AppState.currentRoom] = '';
          
          // UI ÏóÖÎç∞Ïù¥Ìä∏
          UI.drawTabs();
          UI.setActiveTabUI();
          
          // ÏÉà Î∞©Ïóê ÏûÖÏû•
          socket.emit('joinRoom', AppState.currentRoom);
          
          // Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è Î†åÎçîÎßÅ (Ï†ÑÏ≤¥ Î©îÏãúÏßÄ Îã§Ïãú Î°úÎìú)
          DataManager.fetchAndRender(true, true);
          
          // Î™®Î∞îÏùº UI Ï†ïÎ¶¨
          document.body.classList.remove('profile-open');
        } catch (error) {
          console.error('Î∞© Ï†ÑÌôò Ïò§Î•ò:', error);
          // ÏóêÎü¨ Ïãú Ïù¥Ï†Ñ Î∞©ÏúºÎ°ú ÎêòÎèåÎ¶¨Í∏∞ ÎòêÎäî ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïåÎ¶º
        }
      }
    };

    const UI = {
      drawTabs: () => {
        const tabs = DOM.el('#tabs'); tabs.innerHTML='';
        CONFIG.ROOMS.forEach(r=>{
          const b = DOM.create('div', 'tab');
          b.textContent = UI.labelFor(r);
          b.title = r; b.setAttribute('aria-label', r);
          b.onclick = () => RoomManager.switchRoom(r);
          tabs.appendChild(b);
        });
        UI.setActiveTabUI();
      },
      
      labelFor: (roomName) => {
        if (UI.isCompact() && roomName.indexOf('Î∞©Î¨∏ÏòàÏ†ï')===0) return 'Î∞©Î¨∏ÏòàÏ†ï';
        return roomName;
      },
      
      setActiveTabUI: () => {
        document.querySelectorAll('.tab').forEach(t=>{
          t.classList.toggle('active', t.textContent.replace(/\s/g,'') === UI.labelFor(AppState.currentRoom).replace(/\s/g,''));
        });
      },
      
      isCompact: () => window.innerWidth <= 480
    };
    
    // Legacy support for drawTabs - now uses UI.drawTabs()
    function drawTabs(){
      return UI.drawTabs();
    }
    function setActiveTabUI(){
      return UI.setActiveTabUI();
    }
    function labelFor(roomName){
      return UI.labelFor(roomName);
    }
    function initialLetter(name){ const t=String(name||'').trim(); return t? t[0].toUpperCase() : 'U'; }

    /* ===== Ï†ëÏÜçÏûê Í¥ÄÎ¶¨ ===== */
    const ConnectedUsersUI = {
      // Ï†ëÏÜçÏûê Î™©Î°ù Î†åÎçîÎßÅ
      render: (users) => {
        const container = DOM.el('#usersGrid');
        const header = DOM.el('#connectedHeader');
        const section = DOM.el('#connectedUsers');
        
        if (!users || users.length === 0) {
          section.style.display = 'none';
          return;
        }
        
        // Ìó§Îçî ÏóÖÎç∞Ïù¥Ìä∏
        header.textContent = `ÌòÑÏû¨ Ï†ëÏÜçÏûê (${users.length})`;
        
        // ÏïÑÎ∞îÌÉÄ Í∑∏Î¶¨Îìú Î†åÎçîÎßÅ
        container.innerHTML = users.map(user => {
          const safeInitial = initialLetter(user.nickname || '');
          if (user.avatar && user.avatar.trim()) {
            return `<div class="user-avatar" data-user-id="${user.userId}" data-nickname="${(user.nickname||'')}" data-avatar="${(user.avatar||'')}" data-status="${(user.status||'')}" title="${user.nickname || 'User'}">
                      <img src="${user.avatar}" onerror="this.remove();this.parentElement.textContent='${safeInitial}';" />
                    </div>`;
          } else {
            return `<div class="user-avatar" data-user-id="${user.userId}" data-nickname="${(user.nickname||'')}" data-avatar="" data-status="${(user.status||'')}" title="${user.nickname || 'User'}">
                      <span>${safeInitial}</span>
                    </div>`;
          }
        }).join('');
        
        // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
        container.querySelectorAll('.user-avatar').forEach(avatar => {
          avatar.addEventListener('click', () => {
            const userId = avatar.getAttribute('data-user-id');
            const nickname = avatar.getAttribute('data-nickname') || 'User';
            const avatarUrl = avatar.getAttribute('data-avatar') || '';
            const status = avatar.getAttribute('data-status') || '';
            
            openProfile(userId, nickname, avatarUrl);
          });
        });
        
        // ÏÑπÏÖò ÌëúÏãú
        section.style.display = 'block';
      },
      
      // ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä
      addUser: (user) => {
        const existingIndex = AppState.connectedUsers.findIndex(u => u.userId === user.userId);
        if (existingIndex >= 0) {
          // Í∏∞Ï°¥ ÏÇ¨Ïö©Ïûê ÏóÖÎç∞Ïù¥Ìä∏
          AppState.connectedUsers[existingIndex] = user;
        } else {
          // ÏÉà ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä
          AppState.connectedUsers.push(user);
        }
        ConnectedUsersUI.render(AppState.connectedUsers);
      },
      
      // ÏÇ¨Ïö©Ïûê Ï†úÍ±∞
      removeUser: (userId) => {
        AppState.connectedUsers = AppState.connectedUsers.filter(u => u.userId !== userId);
        ConnectedUsersUI.render(AppState.connectedUsers);
      },
      
      // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
      updateUser: (user) => {
        const existingIndex = AppState.connectedUsers.findIndex(u => u.userId === user.userId);
        if (existingIndex >= 0) {
          AppState.connectedUsers[existingIndex] = { ...AppState.connectedUsers[existingIndex], ...user };
          ConnectedUsersUI.render(AppState.connectedUsers);
        }
      },
      
      // Ï†ÑÏ≤¥ Î™©Î°ù ÏÑ§Ï†ï
      setUsers: (users) => {
        AppState.connectedUsers = users || [];
        ConnectedUsersUI.render(AppState.connectedUsers);
      }
    };

    /* ===== API Ìò∏Ï∂ú Ìï®ÏàòÎì§ ===== */
    async function apiCall(method, url, body = null) {
      try {
        const options = {
          method,
          headers: {
            'Content-Type': 'application/json',
          },
        };
        
        if (body && method !== 'GET') {
          options.body = JSON.stringify(body);
        }
        
        const response = await fetch(url, options);
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'API ÏöîÏ≤≠ Ïã§Ìå®');
        }
        
        return await response.json();
      } catch (error) {
        throw error;
      }
    }

    /* ===== Reactions ===== */
    function reactsToCounts(reactions){
      const counts = [];
      for (const k of Object.keys(reactions||{})){
        const arr = reactions[k]||[];
        if (arr.length) counts.push({emoji:k, count:arr.length, mine:(arr.indexOf(AppState.userId)>=0)});
      }
      counts.sort((a,b)=> b.count-a.count || CONFIG.EMOJIS.indexOf(a.emoji)-CONFIG.EMOJIS.indexOf(b.emoji));
      return counts;
    }
    function renderReactsHtml(m){
      const sig = Utils.createReactionSignature(m.reactions||{});
      const chips = reactsToCounts(m.reactions||{}).map(c=>`<span class="chip ${c.mine?'mine':''}" data-mid="${m.mid}" data-emoji="${c.emoji}">${c.emoji} ${c.count}</span>`).join('');
      const picker = CONFIG.EMOJIS.map(e=>`<button class="pick" data-mid="${m.mid}" data-emoji="${e}" title="Î∞òÏùë Ï∂îÍ∞Ä">${e}</button>`).join('');
      return `<div class="reacts" id="reacts-${m.mid}" data-sig='${sig}'>
        <div class="chips">${chips}</div>
        <button class="add-react" data-mid="${m.mid}" title="Î∞òÏùë Ï∂îÍ∞Ä">Ôºã</button>
        <div class="picker hidden" id="picker-${m.mid}">${picker}</div>
      </div>`;
    }
    function bindReactionHandlers(mid){
      const root = document.getElementById('reacts-'+mid); if(!root) return;
      root.querySelectorAll('.chip').forEach(ch=>{
        ch.onclick = (e)=>{ e.stopPropagation(); reactToggle(mid, ch.getAttribute('data-emoji')); };
      });
      const addBtn = root.querySelector('.add-react');
      if (addBtn){
        addBtn.onclick = (e)=>{ e.stopPropagation(); const p=document.getElementById('picker-'+mid); if(p) p.classList.toggle('hidden'); };
      }
      root.querySelectorAll('.pick').forEach(b=>{
        b.onclick = (e)=>{ e.stopPropagation(); reactToggle(mid, b.getAttribute('data-emoji')); const p=document.getElementById('picker-'+mid); if(p) p.classList.add('hidden'); };
      });
    }
    function updateReactsView(m){
      const node = document.getElementById('reacts-'+m.mid);
      if (!node) return;
      const pickerOpen = !(node.querySelector('.picker')?.classList.contains('hidden'));
      const oldSig = node.dataset.sig || '';
      const newSig = Utils.createReactionSignature(m.reactions||{});
      if (pickerOpen || oldSig === newSig) return;
      node.outerHTML = renderReactsHtml(m);
      bindReactionHandlers(m.mid);
    }
    async function reactToggle(mid, emoji){
      try {
        const result = await apiCall('POST', '/api/reactions', { mid, userId: AppState.userId, emoji });
        updateReactsView(result);
        beep();
      } catch (error) {
        alert('Î∞òÏùë Ïã§Ìå®: ' + error.message);
      }
    }

    /* ===== Profile Modal ===== */
    function showProfileModal(nickname, avatar, status){
      DOM.el('#pname').textContent = nickname || 'User';
      DOM.el('#pstatus').textContent = status ? status : 'ÏÉÅÌÉúÎ©îÏãúÏßÄ ÏóÜÏùå';
      const img = DOM.el('#pimg');
      if (avatar && avatar.trim()){
        img.style.display='block';
        img.onerror = ()=>{ img.style.display='none'; img.removeAttribute('src'); };
        img.src = avatar;
      } else {
        img.removeAttribute('src');
        img.style.display='none';
      }
      DOM.el('#pmodal').classList.add('show');
      DOM.el('#pmodal').setAttribute('aria-hidden','false');
    }
    function hideProfileModal(){
      DOM.el('#pmodal').classList.remove('show');
      DOM.el('#pmodal').setAttribute('aria-hidden','true');
    }
    function bindProfileModalBasics(){
      DOM.el('#pback').addEventListener('click', hideProfileModal);
      DOM.el('#pclose').addEventListener('click', hideProfileModal);
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideProfileModal(); });
    }
    async function openProfile(uid, fallbackNick, fallbackAvatar){
      showProfileModal(fallbackNick, fallbackAvatar, 'Î∂àÎü¨Ïò§Îäî Ï§ë‚Ä¶');
      try {
        const profile = await apiCall('GET', `/api/profile/${uid}`);
        showProfileModal(profile.nickname || fallbackNick, profile.avatar || fallbackAvatar, profile.status || '');
      } catch (error) {
        showProfileModal(fallbackNick, fallbackAvatar, '');
      }
    }

    /* ===== Messages ===== */
    function addOrUpdateMsg(m){
      if (document.getElementById('reacts-'+(m.mid||''))){ updateReactsView(m); return; }
      if (m.mid && AppState.cache.renderedMids[AppState.currentRoom].has(m.mid)) return;
      if (m.mid) AppState.cache.renderedMids[AppState.currentRoom].add(m.mid);

      const dayKey = DateUtils.getDateKey(m.ts);
      if (AppState.cache.lastDayRendered[AppState.currentRoom] !== dayKey){
        AppState.cache.lastDayRendered[AppState.currentRoom] = dayKey;
        const sep = document.createElement('div');
        sep.className = 'day-sep';
        sep.innerHTML = `<span class="day-chip">${DateUtils.formatDateLabel(m.ts)}</span>`;
        messagesEl.appendChild(sep);
      }

      const stayAtBottom = (messagesEl.scrollHeight - messagesEl.scrollTop - messagesEl.clientHeight) < 80;

      const row=document.createElement('div');
      const isMe = (m.userId === AppState.userId);
      row.className='msg-row '+(isMe?'me':'other');

      let avatarHtml='';
      if (!isMe){
        const safeInitial = initialLetter(m.nickname||'');
        if (m.avatar){
          avatarHtml = `<button type="button" class="avatar-sm p-open" data-uid="${m.userId}" data-nick="${(m.nickname||'')}" data-av="${(m.avatar||'')}">
                          <img src="${m.avatar}" onerror="this.remove();this.parentElement.textContent='${safeInitial}';" />
                        </button>`;
        } else {
          avatarHtml = `<button type="button" class="avatar-sm p-open" data-uid="${m.userId}" data-nick="${(m.nickname||'')}" data-av=""><span>${safeInitial}</span></button>`;
        }
      } else { avatarHtml = `<div class="avatar-sm" style="display:none;"></div>`; }

      let bubbleInner='';
      if (m.kind==='image' && m.mediaUrl){
        const key = m.mid || m.ts;
        bubbleInner =
          `<div><img id="img-${key}" src="${m.mediaUrl}" alt="${(m.fileName||'image')}" style="max-width:100%; border-radius:12px;" /></div>
           <div class="meta">${(m.nickname||'')} ¬∑ ${DateUtils.formatTimeLabel(m.ts)}</div>`;
      } else {
        bubbleInner =
          `<div>${(m.text||'').replace(/\n/g,'<br/>')}</div>
           <div class="meta">${(m.nickname||'')} ¬∑ ${DateUtils.formatTimeLabel(m.ts)}</div>`;
      }

      const reactsHtml = renderReactsHtml(m);
      row.innerHTML = `${avatarHtml}<div class="bubble">${bubbleInner}${reactsHtml}</div>`;
      messagesEl.appendChild(row);

      bindReactionHandlers(m.mid);

      row.querySelectorAll('.p-open').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const uid = btn.getAttribute('data-uid');
          const nn  = btn.getAttribute('data-nick') || 'User';
          const av  = btn.getAttribute('data-av') || '';
          openProfile(uid, nn, av);
        });
      });

      const img = row.querySelector(m.kind==='image' ? `#img-${CSS.escape(m.mid||m.ts)}` : null);
      if (img && m.kind === 'image'){ 
        // base64 Ïù¥ÎØ∏ÏßÄÎäî ÏßÅÏ†ë srcÎ°ú ÏÑ§Ï†ïÎêòÎØÄÎ°ú ÏùºÎ∞òÏ†ÅÏúºÎ°ú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌïòÏßÄ ÏïäÏùå
        img.onerror = ()=>{ 
          console.error('Ïù¥ÎØ∏ÏßÄ Î°úÎìú Ïã§Ìå®:', m.mediaUrl?.substring(0, 50) + '...');
          const errorDiv = document.createElement('div');
          errorDiv.style.cssText = 'padding:8px; text-align:center; color:#666; border:1px dashed #ccc; border-radius:8px;';
          errorDiv.textContent = 'Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§';
          img.replaceWith(errorDiv);
        };
      }

      if (stayAtBottom) messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    /* ===== Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨ ===== */
    const DataManager = {
      fetchAndRender: async (forceScroll, fullReload = false) => {
        if(!AppState.userId) return;
        
        try {
          // Î∞© Ï†ÑÌôò ÏãúÏóêÎäî Ï†ÑÏ≤¥ Î©îÏãúÏßÄ Îã§Ïãú Î°úÎìú, ÏïÑÎãàÎ©¥ Ï¶ùÎ∂Ñ Î°úÎìú
          const since = fullReload ? 0 : (AppState.cache.lastTs[AppState.currentRoom] || 0);
          const messages = await apiCall('GET', `/api/messages/${AppState.currentRoom}?since=${since}`);
          
          if(messages && messages.length){
            messages.forEach(addOrUpdateMsg);
            AppState.cache.lastTs[AppState.currentRoom] = Math.max(AppState.cache.lastTs[AppState.currentRoom]||0, messages[messages.length-1].ts||0);
            if (forceScroll) messagesEl.scrollTop = messagesEl.scrollHeight;
          }
          const t = new Date().toLocaleTimeString();
          DOM.el('#topStatus').textContent = `Ïó∞Í≤∞Îê® ¬∑ ${t}`;
        } catch (error) {
          console.error(error);
          DOM.el('#topStatus').textContent = 'Ïó∞Í≤∞ ÎÅäÍπÄ';
        }
      }
    };
    
    // Î†àÍ±∞Ïãú ÏßÄÏõê
    async function fetchAndRender(forceScroll){
      return DataManager.fetchAndRender(forceScroll);
    }
    

    async function initMe(){
      try {
        const u = await apiCall('POST', `/api/user/${AppState.userId}`);
        AppState.me = u;
        DOM.el('#nickname').value = u.nickname || '';
        DOM.el('#status').value = u.status || '';
        DOM.el('#avatar').value = u.avatar || '';
        DOM.el('#clearAvatar').checked = false;
        DOM.el('#nicknameView').textContent = u.nickname || 'User';
        DOM.el('#statusView').textContent = u.status || 'ÏÉÅÌÉúÎ©îÏãúÏßÄ‚Ä¶';
        DOM.el('#topStatus').textContent = (u.nickname || 'User') + (u.status ? ` ‚Äî ${u.status}` : '');
        setAvatar(u.avatar || '');
        UI.drawTabs();
        DataManager.fetchAndRender(true);
      } catch (error) {
        console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú Ïã§Ìå®:', error);
      }
    }

    /* ===== Send / Upload ===== */
    async function sendText(){
      if(!AppState.userId || AppState.flags.sending) return;
      const t = DOM.el('#text');
      const v = Utils.sanitizeInput(t.value);
      if(!v) return;

      const sendRoom = AppState.currentRoom;
      AppState.flags.sending = true;
      Utils.setButtonLoading(DOM.el('#sendBtn'), true);
      const mid = Utils.generateMessageId();

      try {
        const result = await apiCall('POST', '/api/messages', {
          room: sendRoom,
          userId: AppState.userId,
          text: v,
          mid
        });
        
        AppState.flags.sending = false;
        Utils.setButtonLoading(DOM.el('#sendBtn'), false);
        t.value = '';
        AppState.cache.lastTs[sendRoom] = Math.max(AppState.cache.lastTs[sendRoom]||0, result.ts||0);
        if (AppState.currentRoom !== sendRoom) return;
        // Ïã§ÏãúÍ∞ÑÏúºÎ°ú Ïù¥ÎØ∏ Î∞õÏïòÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú Ï§ëÎ≥µ Ï≤¥ÌÅ¨ ÌõÑ Ï∂îÍ∞Ä
        if (!AppState.cache.renderedMids[sendRoom].has(result.mid)) {
          addOrUpdateMsg(result);
        }
        beep();
      } catch (error) {
        AppState.flags.sending = false;
        Utils.setButtonLoading(DOM.el('#sendBtn'), false);
        alert('Ï†ÑÏÜ° Ïã§Ìå®: '+error.message);
      }
    }

    /* ===== Logout ===== */
    function doLogout(){
      socket.emit('leaveRoom', AppState.currentRoom);
      AppState.userId=null; AppState.me=null;
      messagesEl.innerHTML='';
      Object.keys(AppState.cache.renderedMids).forEach(room => AppState.cache.renderedMids[room].clear());
      Object.keys(AppState.cache.lastTs).forEach(k=> AppState.cache.lastTs[k]=0);
      Object.keys(AppState.cache.lastDayRendered).forEach(k=> AppState.cache.lastDayRendered[k]='');
      setAvatar('');
      ['nickname','status','avatar'].forEach(id=>{ const n=DOM.el('#'+id); if(n) n.value=''; });
      const ca = DOM.el('#clearAvatar'); if (ca) ca.checked = false;
      DOM.el('#nicknameView').textContent='User';
      DOM.el('#statusView').textContent='ÏÉÅÌÉúÎ©îÏãúÏßÄ‚Ä¶';
      DOM.el('#topStatus').textContent='‚Äî';
      enableUI(false);

      DOM.el('#loginName').value='';
      DOM.el('#loginBirth').value='';
      DOM.el('#auth').classList.remove('hidden');
      document.body.classList.add('auth-open');

      document.body.classList.remove('profile-open');
      hideProfileModal();
      
      // Ï†ëÏÜçÏûê Î™©Î°ù Ï¥àÍ∏∞Ìôî
      ConnectedUsersUI.setUsers([]);
    }

    function bindUI(){
      DOM.el('#sendBtn').onclick=sendText;
      DOM.el('#text').addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendText(); } });

      // ÌîÑÎ°úÌïÑ Ï†ÄÏû•
      DOM.el('#saveBtn').onclick= async ()=>{
        if(!AppState.userId) return;
        const nickname = DOM.el('#nickname').value;
        const status   = DOM.el('#status').value;
        const avValue  = (DOM.el('#avatar').value||'').trim();
        const clearAv  = DOM.el('#clearAvatar').checked;

        const profile = { nickname, status };
        if (clearAv) profile.clearAvatar = true;   
        if (avValue) profile.avatar = avValue;     

        try {
          const u = await apiCall('PUT', `/api/profile/${AppState.userId}`, profile);
          AppState.me = u;
          DOM.el('#nicknameView').textContent = u.nickname || 'User';
          DOM.el('#statusView').textContent = u.status || 'ÏÉÅÌÉúÎ©îÏãúÏßÄ‚Ä¶';
          DOM.el('#topStatus').textContent = (u.nickname || 'User') + (u.status ? ` ‚Äî ${u.status}` : '');
          setAvatar(u.avatar || '');
          DOM.el('#avatar').value = u.avatar || '';
          DOM.el('#clearAvatar').checked = false;
          
          // Ï†ëÏÜçÏûê Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏïåÎ¶º
          socket.emit('userProfileUpdated', {
            userId: AppState.userId,
            nickname: u.nickname,
            avatar: u.avatar,
            status: u.status
          });
          
          beep();
        } catch (error) {
          alert('Ï†ÄÏû• Ïã§Ìå®: ' + error.message);
        }
      };

      // ÏïÑÎ∞îÌÉÄ ÏûÖÎ†• Ïãú "ÏßÄÏö∞Í∏∞" ÏûêÎèô Ìï¥Ï†ú
      DOM.el('#avatar').addEventListener('input', ()=>{
        if ((DOM.el('#avatar').value||'').trim()) DOM.el('#clearAvatar').checked = false;
      });

      // ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú
      DOM.el('#photoBtn').onclick=()=>{ if(AppState.userId) DOM.el('#image').click(); };
      DOM.el('#image').addEventListener('change', async ()=>{
        const f=DOM.el('#image').files[0];
        if(!AppState.userId||!f||AppState.flags.uploading) return;
        if(f.size>10*1024*1024){ alert('10MB Ïù¥ÌïòÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.'); DOM.el('#image').value=''; return; }

        const uploadRoom = AppState.currentRoom;
        AppState.flags.uploading = true;
        DOM.el('#photoBtn').disabled = true;
        const mid = Utils.generateMessageId();

        try {
          // ÌååÏùºÏùÑ base64Î°ú Î≥ÄÌôò
          const base64Data = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(f);
          });

          const requestBody = {
            room: uploadRoom,
            userId: AppState.userId,
            mid: mid,
            imageData: base64Data,
            fileName: f.name,
            mimeType: f.type
          };

          const response = await fetch('/api/upload', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestBody)
          });

          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'ÏóÖÎ°úÎìú Ïã§Ìå®');
          }

          const result = await response.json();
          AppState.flags.uploading = false;
          DOM.el('#photoBtn').disabled = false;
          DOM.el('#image').value = '';
          AppState.cache.lastTs[uploadRoom] = Math.max(AppState.cache.lastTs[uploadRoom]||0, result.ts||0);
          if (AppState.currentRoom !== uploadRoom) return;
          if (!AppState.cache.renderedMids[uploadRoom].has(result.mid)) {
            addOrUpdateMsg(result);
          }
          beep();
        } catch (error) {
          AppState.flags.uploading = false;
          DOM.el('#photoBtn').disabled = false;
          DOM.el('#image').value = '';
          alert('ÏóÖÎ°úÎìú Ïã§Ìå®: '+error.message);
        }
      });

      el('#startBtn').onclick=doLogin;
      el('#logoutBtn').onclick=doLogout;

      // Retro toggle
      el('#toggle98').addEventListener('click', ()=>{ applyTheme98(!document.body.classList.contains('win98')); beep(); });

      // Profile drawer toggle (mobile)
      el('#profileBtn').addEventListener('click', ()=>{ document.body.classList.add('profile-open'); });
      el('#scrim').addEventListener('click', ()=>{ document.body.classList.remove('profile-open'); });

      // ÌîÑÎ°úÌïÑ Î™®Îã¨ Í∏∞Î≥∏ ÎèôÏûë
      bindProfileModalBasics();

      // ÎìúÎûòÍ∑∏ Í∞ÄÎä•Ìïú Î°úÍ∑∏Ïù∏ Îã§Ïù¥ÏñºÎ°úÍ∑∏
      makeDialogDraggable('#dialogCard','#dlgDragHandle');

      // Î¶¨ÏÇ¨Ïù¥Ï¶à Ïãú ÌÉ≠ ÎùºÎ≤®/ÏÉÅÌÉú Í∞±Ïã†
      let lastCompact = UI.isCompact();
      window.addEventListener('resize', ()=>{
        const nowCompact = UI.isCompact();
        if (nowCompact !== lastCompact){
          UI.drawTabs(); UI.setActiveTabUI();
          lastCompact = nowCompact;
        }
      });
    }

    /* ===== Login ===== */
    async function doLogin(){
      const loginBtn = DOM.el('#startBtn');
      loginBtn.disabled = true;
      const card = DOM.el('#dialogCard');
      const name=(DOM.el('#loginName').value||'').trim();
      const b4=(DOM.el('#loginBirth').value||'').replace(/\D/g,'').slice(0,4);
      if(!name || b4.length!==4){ 
        loginBtn.disabled = false;
        card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake'); 
        return; 
      }

      try {
        const u = await apiCall('POST', '/api/login', { name, birth4: b4 });
        AppState.userId = u.id;
        DOM.el('#auth').classList.add('hidden'); 
        document.body.classList.remove('auth-open');
        enableUI(true); 
        UI.drawTabs(); 
        initMe();
        socket.emit('joinRoom', AppState.currentRoom);
        
        // Ï†ëÏÜçÏûê Î™©Î°ùÏóê Ï∂îÍ∞Ä
        socket.emit('userLogin', { userId: AppState.userId });
        
        beep();
      } catch (error) {
        console.error('Login error:', error);
        alert('Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ' + error.message);
      } finally {
        loginBtn.disabled = false;
      }
    }

    // Dialog drag helper
    function makeDialogDraggable(cardSel, handleSel){
      const card = el(cardSel), handle = el(handleSel); if(!card||!handle) return;
      let sx=0, sy=0, ox=0, oy=0, dragging=false;
      const down=(e)=>{ dragging=true; const r=card.getBoundingClientRect(); ox=r.left; oy=r.top; sx=e.clientX; sy=e.clientY; handle.style.cursor='grabbing'; e.preventDefault(); };
      const move=(e)=>{ if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; card.style.position='fixed'; card.style.left=(ox+dx)+'px'; card.style.top=(oy+dy)+'px'; };
      const up=()=>{ dragging=false; handle.style.cursor='grab'; };
      handle.addEventListener('mousedown',down); window.addEventListener('mousemove',move); window.addEventListener('mouseup',up);
    }

    // Socket.io Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
    socket.on('newMessage', (message) => {
      if (message.room === AppState.currentRoom) {
        addOrUpdateMsg(message);
        AppState.cache.lastTs[AppState.currentRoom] = Math.max(AppState.cache.lastTs[AppState.currentRoom] || 0, message.ts || 0);
      }
    });

    socket.on('reactionUpdate', (message) => {
      if (message.room === AppState.currentRoom) {
        updateReactsView(message);
      }
    });

    // ===== Ï†ëÏÜçÏûê Í¥ÄÎ†® Socket Ïù¥Î≤§Ìä∏ =====
    socket.on('connectedUsersList', (data) => {
      ConnectedUsersUI.setUsers(data.users || []);
    });

    socket.on('userConnected', (user) => {
      ConnectedUsersUI.addUser(user);
    });

    socket.on('userDisconnected', (data) => {
      ConnectedUsersUI.removeUser(data.userId);
    });

    socket.on('userProfileUpdated', (user) => {
      ConnectedUsersUI.updateUser(user);
    });

    /* ===== iOS Ï£ºÏÜåÏ∞Ω ÎÜíÏù¥ Î≥ÄÎèô ÎåÄÏùëÏö© --vh ÏÑ∏ÌåÖ ===== */
    (function setVhUnit(){
      const setVh = () => {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      };
      setVh();
      window.addEventListener('resize', setVh, {passive:true});
      window.addEventListener('orientationchange', setVh, {passive:true});
    })();

    // ===== Boot =====
    (function boot(){
      bindUI(); enableUI(false);
      // Î°úÍ∑∏Ïù∏ ÏûêÎèôÏôÑÏÑ± Î∞©ÏßÄ + Ìï≠ÏÉÅ ÎπàÏπ∏
      const ln=el('#loginName'), lb=el('#loginBirth');
      ln.name='n_'+Math.random().toString(36).slice(2); lb.name='b_'+Math.random().toString(36).slice(2);
      ln.value=''; lb.value='';
      restoreTheme98(); // ÌÖåÎßà Î≥µÏõê
      attachBeepTo('.tab,.btn,.chip,.add-react,.pick');
    })();
  </script>
</body>
</html>